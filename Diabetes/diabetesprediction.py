# -*- coding: utf-8 -*-
"""DiabetesPrediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hdQPS1jLggrAl8tdQY5qM4rps7S0-G71

# 1.Proje AÃ§Ä±klamasÄ±
### Proje BaÅŸlÄ±ÄŸÄ±:
Diyabet HastalÄ±ÄŸÄ± Tahmini

### Projenin AmacÄ±:
Bu projenin amacÄ±, bireylerin Ã§eÅŸitli saÄŸlÄ±k verileri kullanÄ±larak Tip 2 diyabet hastalÄ±ÄŸÄ±na yakalanma riskini tahmin edebilen bir makine Ã¶ÄŸrenimi modeli geliÅŸtirmektir.

### AraÅŸtÄ±rma Sorusu:
KiÅŸilerin saÄŸlÄ±k verileri kullanÄ±larak diyabet hastalÄ±ÄŸÄ±na yakalanÄ±p yakalanmayacaÄŸÄ± doÄŸru bir ÅŸekilde tahmin edilebilir mi?

### Veri Seti Bilgileri:
Projede kullanÄ±lan veri seti, 100.000 bireye ait demografik ve saÄŸlÄ±k verilerini iÃ§eren bÃ¼yÃ¼k Ã¶lÃ§ekli bir aÃ§Ä±k veri kÃ¼mesidir. Veri seti Ã§eÅŸitli yaÅŸ gruplarÄ±ndan, cinsiyetlerden ve saÄŸlÄ±k durumlarÄ±ndan bireyleri iÃ§ermekte olup, daha genel ve temsili bir popÃ¼lasyonu yansÄ±tmaktadÄ±r.

gender: Bireyin cinsiyeti (Female, Male, Other)

age: YaÅŸ (float)

hypertension: YÃ¼ksek tansiyon durumu (0 = HayÄ±r, 1 = Evet)

heart_disease: Kalp hastalÄ±ÄŸÄ± geÃ§miÅŸi (0 = HayÄ±r, 1 = Evet)

smoking_history: Sigara iÃ§me geÃ§miÅŸi (No Info, never, current, former, etc.)

bmi: VÃ¼cut kitle indeksi (kg/mÂ²)

HbA1c_level: Son 2-3 aylÄ±k ortalama kan ÅŸekeri seviyesini gÃ¶steren HbA1c deÄŸeri

blood_glucose_level: AnlÄ±k kan ÅŸekeri dÃ¼zeyi

diabetes: Diyabet durumu (1 = Hasta, 0 = SaÄŸlÄ±klÄ±)

# 2. ğŸ“¦ Gerekli KÃ¼tÃ¼phanelerin YÃ¼klenmesi
"""

# Temel KÃ¼tÃ¼phaneler
import numpy as np
import pandas as pd

# GÃ¶rselleÅŸtirme
import matplotlib.pyplot as plt
import seaborn as sns

#Modelleme
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.compose import ColumnTransformer
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix,roc_auc_score, roc_curve
from sklearn.pipeline import Pipeline

#Ornekleme
from imblearn.over_sampling import SMOTE
from imblearn.under_sampling import RandomUnderSampler
from imblearn.pipeline import Pipeline as imbPipeline

#Decimal
pd.options.display.float_format = "{:.2f}".format

"""# 3. ğŸ“¥ Verinin YÃ¼klenmesi ve Ä°lk Ä°nceleme"""

# Google Colab'a dosya yÃ¼kleme
from google.colab import files
uploaded = files.upload()


df = pd.read_csv("diabetes_prediction_dataset.csv")

df.head()

df.info()

df.describe()

df.isnull().sum()

"""# 4. ğŸ” KeÅŸifsel Veri Analizi (EDA)"""

duplicateData = df[df.duplicated()]
print("Tekrarlanan Veri SayÄ±sÄ±: ", duplicateData.shape)

df = df.drop_duplicates()

df.info()

#Benzersiz DeÄŸerlerin SayÄ±sÄ±nÄ± Bulma

for column in df.columns:
  distinctValue=len(df[column].unique())
  print(f"{column} sÃ¼tunun benzersiz deÄŸer sayÄ±sÄ±: {distinctValue}")

#Eksik DeÄŸer KontrolÃ¼
df.isnull().sum()

for column in df.columns:
  print(f"{column} sÃ¼tunun deÄŸer sayÄ±larÄ±:\n {df[column].value_counts()}")

#96146 veride 18 tane Other deÄŸeri var gÃ¼rÃ¼ltÃ¼ oluÅŸturmamasÄ± iÃ§in Ã§Ä±karÄ±lÄ±yor
df = df[df['gender'] != 'Other']

df.info()

#verileri formatlayÄ±p okunaklÄ± hale getirme
df.describe().style.format("{:.2f}")

# Age DaÄŸÄ±lÄ±mÄ±
plt.hist(df['age'], bins=30,edgecolor="black")
plt.title('Age DagÄ±lÄ±m GrafiÄŸi')
plt.xlabel('Age')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

# Gender DaÄŸÄ±lÄ±mÄ±
sns.countplot(x='gender', data=df)
plt.title('Gender DagÄ±lÄ±m GrafiÄŸi')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

# BMI DaÄŸÄ±lÄ±mÄ±
sns.histplot(df['bmi'], bins=30, kde=True)
plt.title("BMI DaÄŸÄ±lÄ±m GrafiÄŸi")
plt.xlabel("BMI")
plt.ylabel("KiÅŸi SayÄ±sÄ±")
plt.show()

#Hypertension DaÄŸÄ±lÄ±mÄ±
sns.countplot(x='hypertension', data=df)
plt.title('Hypertension DaÄŸÄ±lÄ±m GrafiÄŸi')
plt.xlabel('Hypertension')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

#Heart Disease DaÄŸÄ±lÄ±mÄ±
sns.countplot(x='heart_disease', data=df)
plt.title('Heart Disease DaÄŸÄ±lÄ±m GrafiÄŸi')
plt.xlabel('Heart Disease')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

#Diabetes  DaÄŸÄ±lÄ±mÄ±
sns.countplot(x='diabetes', data=df)
plt.title('Diabetes  DaÄŸÄ±lÄ±m GrafiÄŸi')
plt.xlabel('Diabetes ')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

#Countplot GrafiÄŸi
sns.countplot(x='smoking_history', data=df)
plt.title('Smoking History DaÄŸÄ±lÄ±m GrafiÄŸi')
plt.ylabel('KiÅŸi SayÄ±sÄ±')
plt.show()

#Ä°ki DeÄŸiÅŸkenli Analiz
#Ä°ki deÄŸiÅŸkenli analiz, "hangi deÄŸiÅŸken hedefi etkiliyor?" ve "bu etki gÃ¼Ã§lÃ¼ mÃ¼?" gibi sorulara cevap vererek modelinin daha isabetli ve anlaÅŸÄ±lÄ±r olmasÄ±nÄ± saÄŸlar.

#BMI vs Diabetes
sns.boxplot(x='diabetes', y='bmi', data=df)
plt.title('BMI vs Diabetes')
plt.show()

#Age vs Diabetes
sns.boxplot(x='diabetes', y='age', data=df)
plt.title('Age vs Diabetes')
plt.show()

#gender vs diabetes
sns.countplot(x='gender', hue='diabetes', data=df)
plt.title('Gender vs Diabetes')
plt.show()

#HbA1c level vs Diabetes
sns.boxplot(x='diabetes', y='HbA1c_level', data=df)
plt.title('HbA1c level vs Diabetes')
plt.show()

#Blood Glucose level vs Diabetes
sns.boxplot(x='diabetes', y='blood_glucose_level', data=df)
plt.title('Blood Glucose Level vs Diabetes')
plt.show()

#Heart Disease vs Diabetes
sns.countplot(x='heart_disease', hue='diabetes', data=df)
plt.title('Heart Disease vs Diabetes')
plt.show()

#Hypertension vs Diabetes
sns.countplot(x='hypertension', hue='diabetes', data=df)
plt.title('Hypertension vs Diabetes')
plt.show()

sns.pairplot(df, hue='diabetes')
plt.show()

"""# 5. ğŸ”§ Veri Ã–n Ä°ÅŸleme"""

# Smoking_History SadeleÅŸtirme
def newSmoking(smokingStatus):
    if smokingStatus in ['never', 'No Info']:
        return 'non-smoker'
    elif smokingStatus == 'current':
        return 'current'
    elif smokingStatus in ['ever', 'former', 'not current']:
        return 'past_smoker'

# Smoking_History GÃ¼ncelleme
df['smoking_history'] = df['smoking_history'].apply(newSmoking)

# Yeni DeÄŸerler
print(df['smoking_history'].value_counts())

data = df.copy()

#One Hot Encoding
def OHEncoding(df, columnName):
    #Yeni SÃ¼tunlarÄ± OluÅŸturma
    dummies = pd.get_dummies(df[columnName], prefix=columnName)

    #Eski SÃ¼tunlarÄ±n Yerine Yeni SÃ¼tunlarÄ± Getirme
    df = pd.concat([df.drop(columnName, axis=1), dummies], axis=1)
    return df

# One HOt Encoding Gendera uygulama
data = OHEncoding(data, 'gender')

# One HOt Encoding Smoking_History  uygulama
data = OHEncoding(data, 'smoking_history')

#Korelasyon Matrisi
corrMatrix = data.corr()
#Grafik 1
plt.figure(figsize=(15, 10))
sns.heatmap(corrMatrix, annot=True, cmap='coolwarm', linewidths=0.5, fmt='.2f')
plt.title("Correlation Matrix Heatmap")
plt.show()


#Grafik 2
corr = data.corr()
targetCorr = corr['diabetes'].drop('diabetes')

#IsÄ± HaritasÄ±nÄ± SÄ±ralama Azalan Åekilde
targetCorrSort = targetCorr.sort_values(ascending=False)

sns.set(font_scale=0.8)
sns.set_style("white")
sns.heatmap(targetCorrSort.to_frame(), cmap="coolwarm", annot=True, fmt='.2f')
plt.title('Diyabet Korelasyonu')
plt.show()

"""### Veri DengesizliÄŸi DÃ¼zenleme"""

sns.countplot(x='diabetes', data=df)
plt.title('Diabetes Distribution')
plt.show()

df['diabetes'].value_counts()

#Ornekleme
over = SMOTE(sampling_strategy=0.1)
under = RandomUnderSampler(sampling_strategy=0.5)

#Veri Ã–n Ä°ÅŸleme
preprocessor = ColumnTransformer(transformers=[
        ('num', StandardScaler(), ['age', 'bmi', 'HbA1c_level', 'blood_glucose_level','hypertension','heart_disease']),
        ('cat', OneHotEncoder(), ['gender','smoking_history'])
    ])

#SÃ¼tunlarÄ± AyÄ±rma
X = df.drop('diabetes', axis=1)
y = df['diabetes']

# Pipeline OluÅŸturma
pipe = imbPipeline(steps=[('preprocessor', preprocessor),
                      ('over', over),
                      ('under', under),
                      ('classifier', RandomForestClassifier())])

"""
# 7. ğŸ¤– Model SeÃ§imi ve EÄŸitimi"""

#Hiperparametre OluÅŸturm
param_grid = {
    'classifier__n_estimators': [50, 100, 200],
    'classifier__max_depth': [None, 10, 20],
    'classifier__min_samples_split': [2, 5, 10],
    'classifier__min_samples_leaf': [1, 2, 4]
}

# GridSearchCV OluÅŸturma
gridSearch = GridSearchCV(pipe, param_grid, cv=5)

# Train Test Setine ayÄ±rma
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Train Modeli OluÅŸturma
gridSearch.fit(X_train, y_train)

# En Ä°yi Parametre
print("En Ä°yi Parametre: ", gridSearch.best_params_)

"""# 8. ğŸ“Š Model DeÄŸerlendirme"""

# GridSearchCv Df atama Ve GÃ¶rselleÅŸtirme
resultsDf = pd.DataFrame(gridSearch.cv_results_)
plt.figure(figsize=(8, 6))
sns.lineplot(data=resultsDf, x='param_classifier__n_estimators', y='mean_test_score', hue='param_classifier__min_samples_split', palette='viridis')
plt.title('Hyperparameters SonuÃ§larÄ±')
plt.xlabel('Estimator SayÄ±larÄ±')
plt.ylabel('Ort Test PuanÄ±')
plt.show()

# Test KÃ¼mesi Ã¼zerinden Tahminde bulunma
y_pred = gridSearch.predict(X_test)

# Model DeÄŸerlendirme

#Accuracy
print("Model Accuracy: ", accuracy_score(y_test, y_pred))

#Classification Report
print(classification_report(y_test, y_pred))#macro tÃ¼m sÄ±nÄ±f weighted sÄ±nÄ±f ortalamasÄ±

#ROC_AUC
y_probs = gridSearch.predict_proba(X_test)[:, 1]

roc_auc = roc_auc_score(y_test, y_probs)
print("ROC-AUC Score:", roc_auc)

fpr, tpr, thresholds = roc_curve(y_test, y_probs)

plt.figure(figsize=(8, 6))
plt.plot(fpr, tpr, label=f'ROC Curve (AUC = {roc_auc:.2f})')
plt.plot([0, 1], [0, 1], 'k--')  # rastgele tahmin Ã§izgisi
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate (Recall)')
plt.title('ROC Curve')
plt.legend(loc='lower right')
plt.grid()
plt.show()



# Confusion matrix
cm = confusion_matrix(y_test, y_pred)
plt.figure(figsize=(8, 6))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.title('Confusion Matrix')
plt.xlabel('Tahmin Edilen')
plt.ylabel('GerÃ§ek')
plt.show()

print("Train Accuracy:", gridSearch.score(X_train, y_train))
print("Test Accuracy :", gridSearch.score(X_test, y_test))

"""# Verileri KullanÄ±cÄ±nÄ±n girdiÄŸi"""

# EÄŸitilmiÅŸ model ve iÅŸlem hattÄ±nÄ± (pipeline) GridSearchCV'den alÄ±yoruz
kullaniciModel = gridSearch.best_estimator_

# KullanÄ±cÄ±dan girdi al
kullaniciGirdi = {
    'age': float(input("YaÅŸÄ±nÄ±zÄ± girin: ")),
    'gender': input("Cinsiyetinizi girin (Male/Female): "),
    'hypertension': int(input("Hipertansiyon var mÄ±? (1: Evet, 0: HayÄ±r): ")),
    'heart_disease': int(input("Kalp hastalÄ±ÄŸÄ± var mÄ±? (1: Evet, 0: HayÄ±r): ")),
    'smoking_history': input("Sigara geÃ§miÅŸi (non-smoker / past_smoker / current): "),
    'bmi': float(input("BMI: ")),
    'HbA1c_level': float(input("HbA1c seviyesi: ")),
    'blood_glucose_level': float(input("Kan ÅŸekeri seviyesi: "))
}

# KullanÄ±cÄ± Girdileri DataFrame'e Ã§evir
kullaniciDf = pd.DataFrame([kullaniciGirdi])

# Tahmin
pred = kullaniciModel.predict(kullaniciDf)[0]
proba = kullaniciModel.predict_proba(kullaniciDf)[0][1]

# SonuÃ§
if pred == 1:
    print(f"ğŸ”´ Tahmin: Diyabet hastasÄ±sÄ±nÄ±z. (OlasÄ±lÄ±k: %{proba*100:.2f})")
else:
    print(f"ğŸŸ¢ Tahmin: Diyabet hastasÄ± deÄŸilsiniz. (OlasÄ±lÄ±k: %{(1-proba)*100:.2f})")

"""# 9. ğŸ“ SonuÃ§ ve Yorumlar

Bu projede, diyabet hastalÄ±ÄŸÄ±nÄ± tahmin etmeye yÃ¶nelik geliÅŸtirilen makine Ã¶ÄŸrenmesi modeli oldukÃ§a yÃ¼ksek baÅŸarÄ± gÃ¶stermiÅŸtir. Elde edilen performans metrikleri, modelin hem genel doÄŸruluÄŸunun hem de hasta sÄ±nÄ±fÄ±nÄ± ayÄ±rt edebilme gÃ¼cÃ¼nÃ¼n yÃ¼ksek olduÄŸunu gÃ¶stermektedir.

### Modelin GÃ¼Ã§lÃ¼ YÃ¶nleri:
**YÃ¼ksek Genel DoÄŸruluk:**
Model, %94.84 doÄŸruluk ile test verisinde gÃ¼Ã§lÃ¼ bir performans sergilemiÅŸtir.

**GÃ¼Ã§lÃ¼ ROC-AUC Skoru:**
ROC-AUC deÄŸeri 0.9735 olup, modelin pozitif ve negatif sÄ±nÄ±flarÄ± birbirinden ayÄ±rma baÅŸarÄ±sÄ±nÄ±n Ã§ok yÃ¼ksek olduÄŸunu gÃ¶stermektedir.

**Ä°yi Recall :**
Diyabetli bireyler iÃ§in recall oranÄ± %80â€™dir. Bu, modelin gerÃ§ek hasta olan kiÅŸilerin %80â€™ini baÅŸarÄ±yla tespit ettiÄŸini gÃ¶stermektedir â€” saÄŸlÄ±k uygulamalarÄ± iÃ§in kritik bir Ã¶zelliktir.

**Dengeli F1-Score:**
Pozitif sÄ±nÄ±fta f1-score = 0.73, negatif sÄ±nÄ±fta f1-score = 0.97 olarak hesaplanmÄ±ÅŸtÄ±r. Bu da modelin hem doÄŸruluk hem hassasiyet arasÄ±nda iyi bir denge kurduÄŸunu gÃ¶sterir.

### Modelin ZayÄ±f YÃ¶nleri:
**Pozitif SÄ±nÄ±f Ä°Ã§in DÃ¼ÅŸÃ¼k Precision (0.68):**
Model, hasta olmayan bazÄ± bireyleri yanlÄ±ÅŸlÄ±kla â€œhastaâ€ olarak tahmin etmiÅŸ olabilir (false positive). Bu durum, gereksiz tetkiklere veya kaynak kullanÄ±mÄ±na yol aÃ§abilir.

**Veri DengesizliÄŸi:**
diabetes=1 sÄ±nÄ±fÄ±, veri setinde Ã§ok daha az sayÄ±da Ã¶rneÄŸe sahiptir. SMOTE ve undersampling gibi yÃ¶ntemlerle bu durum dengelenmiÅŸ olsa da, doÄŸal dengesizlik modelin Ã¶ÄŸrenme sÃ¼recini etkilemiÅŸ olabilir.

**TÄ±bbi Verinin BelirsizliÄŸi:**
GerÃ§ek dÃ¼nyada tÄ±bbi tanÄ±lar her zaman kesin olmayabilir. Ã–zellikle "No Info" gibi kategorilerin non-smoker ile birleÅŸtirilmesi gibi veri temizleme adÄ±mlarÄ±, potansiyel bilgi kaybÄ± yaratabilir.

### OlasÄ± Hata KaynaklarÄ±:
Eksik ya da yanÄ±ltÄ±cÄ± veri (Ã¶rneÄŸin BMI uÃ§ deÄŸerleri)

Sigara geÃ§miÅŸi gibi metinsel verilerin yeniden sÄ±nÄ±flandÄ±rÄ±lmasÄ±

Veri setinin sÄ±nÄ±flar arasÄ± dengesizliÄŸi

### Genel DeÄŸerlendirme:
Bu proje kapsamÄ±nda geliÅŸtirilen model, diyabet hastalÄ±ÄŸÄ±nÄ±n tahmini iÃ§in oldukÃ§a baÅŸarÄ±lÄ±dÄ±r. Ã–zellikle gerÃ§ek pozitif hastalarÄ± yakalama oranÄ± yÃ¼ksek (recall = 0.80) olduÄŸu iÃ§in erken tanÄ± aÃ§Ä±sÄ±ndan deÄŸerli bir araÃ§ olabilir. ROC-AUC deÄŸeri 0.97'nin Ã¼zerinde olan modeller genellikle yÃ¼ksek ayrÄ±m gÃ¼cÃ¼ne sahip kabul edilir.
"""